import React, { useState, useEffect, useRef } from 'react';

// --- Configuration & Constants ---

const APP_TITLE = "Analizator Danych CSV";
const APP_SUBTITLE_FULL = "Prześlij plik CSV, aby uzyskać analizę opartą na AI, lub uruchom test z danymi demonstracyjnymi.";
const APP_SUBTITLE_DEMO_ONLY = "Uruchom test z danymi demonstracyjnymi, aby zobaczyć symulowaną analizę.";

const PREDEFINED_TOPICS = [
    { 
        id: "holistic",
        title: "Analiza Holistyczna",
        question: "Provide a comprehensive holistic analysis of the provided CSV data, considering all aspects such as bottlenecks, workstation utilization, quality, changeovers, employee performance, costs, energy consumption, and downtime. Synthesize these insights into an overall assessment of the process, highlighting key interdependencies, major strengths, critical weaknesses, and strategic recommendations for improvement. Deliver the summary in Polish."
    },
    { id: "bottlenecks", title: "Wąskie Gardła w Procesie", question: "Analyze the provided CSV data for potential bottlenecks. Identify where they might occur, their impact, and the largest bottleneck. Provide a concise summary in Polish." },
    { id: "utilization", title: "Wykorzystanie Stanowisk Pracy", question: "Based on the CSV data, analyze workstation utilization. Note any under/overutilization and average/lowest availability if inferable. Provide a concise summary in Polish." },
    { id: "quality", title: "Jakość", question: "Examine the CSV for insights into product/process quality. Indicate any quality issues or their absence. Provide a concise summary in Polish." },
    { id: "changeovers", title: "Przezbrojenia", question: "Analyze the CSV for information on changeovers/retooling and their impact on efficiency. Provide a concise summary in Polish." },
    { id: "employees", title: "Pracownicy", question: "Based on the CSV, analyze employee workload/efficiency. Note any imbalances or issues with operator numbers. Provide a concise summary in Polish." },
    { id: "costs", title: "Koszty", question: "Analyze the CSV to identify key cost drivers, largest/smallest cost categories, and potential ROI if data supports it. Provide a concise summary in Polish." },
    { id: "energy", title: "Zużycie Energii", question: "Examine the CSV for energy consumption patterns. Which workstations/products consume most energy if inferable? Provide a concise summary in Polish." },
    { id: "downtime", title: "Awarie Przestoje", question: "Analyze the CSV for failures/unplanned downtime and their impact on the process. Provide a concise summary in Polish." }
];

const SAMPLE_CSV_DATA_FOR_DEMO = `Workstation,Status,TasksCompleted,ProcessingTime_min,Energy_kWh,MaterialCost_PLN,LaborCost_PLN,Downtime_hours,DefectRate_%,ChangeoverTime_min,OperatorWorkload_%
ST1,Operational,150,30,15,2500,1200,2,1.5,45,75
ST2,Maintenance,0,0,2,100,50,8,0,0,0
ST3,Operational,200,25,20,3000,1500,1,0.5,30,90
ST4,Idle,50,60,5,1000,800,0,2.0,60,40
ST5,Operational,180,28,18,2800,1400,1.5,1.0,35,85
`;

const SIMULATED_ANALYSIS_RESULTS = PREDEFINED_TOPICS.map(topic => {
    let simulatedAnswer = `To jest symulowana odpowiedź dla tematu: "${topic.title}". `;
    switch (topic.id) {
        case "holistic": 
            simulatedAnswer += "Przeprowadzając całościową ocenę na podstawie danych demonstracyjnych, można zauważyć kilka kluczowych obszarów. Stanowisko ST2 (w konserwacji) oraz ST4 (bezczynne z długim czasem przetwarzania) jawią się jako główne wąskie gardła, negatywnie wpływając na ogólny przepływ i generując koszty (szczególnie 8-godzinny przestój ST2). Wykorzystanie stanowisk ST3 (90%) i ST5 (85%) jest wysokie, co jest pozytywnym sygnałem, jednak ST4 (40%) pozostaje znacznie niedociążone. Jakość produktów wydaje się być na ogół pod kontrolą, chociaż ST4 z najwyższym wskaźnikiem defektów (2.0%) przy relatywnie niskiej liczbie wykonanych zadań może wymagać bliższej obserwacji. Pod względem kosztów, ST3 generuje najwyższe koszty materiałowe i pracy, a wspomniany przestój ST2 również stanowi znaczący ukryty koszt. Ogólnie rzecz biorąc, proces wykazuje potencjał do optymalizacji, zwłaszcza poprzez usprawnienie zarządzania konserwacją (minimalizacja przestojów ST2) oraz lepsze zbalansowanie obciążenia pracą (szczególnie dla ST4). Brak szczegółowych danych dotyczących przezbrojeń, efektywności pracowników czy zużycia energii w tym demo ogranicza pełniejszą ocenę tych aspektów, ale wskazane obszary są priorytetowe.";
            break;
        case "bottlenecks":
            simulatedAnswer += "Na podstawie przykładowych danych, ST2 (Konserwacja) i ST4 (Bezczynność z długim czasem przetwarzania) wydają się być wąskimi gardłami. ST2 powoduje 8h przestoju, a ST4 przetwarza tylko 50 zadań w 60 minut.";
            break;
        case "utilization":
            simulatedAnswer += "Stanowiska ST3 (90%) i ST5 (85%) wykazują wysokie wykorzystanie. ST4 (40%, Bezczynne) jest niedociążone. ST2 ma 0% wykorzystania (Konserwacja).";
            break;
        case "quality":
            simulatedAnswer += "Ogólny wskaźnik defektów jest niski. ST4 ma najwyższy (2.0%) przy niskiej liczbie zadań, co może wymagać uwagi.";
            break;
        case "costs":
            simulatedAnswer += "ST3 generuje najwyższe koszty operacyjne (Materiały: 3000 PLN, Praca: 1500 PLN). Przestój ST2 (8h) to znaczący koszt pośredni.";
            break;
        default:
            simulatedAnswer += "Analiza tego aspektu wymagałaby bardziej szczegółowych danych lub specyficznych kolumn w pliku CSV, których przykładowe dane mogą nie zawierać w pełni. Dla celów demonstracyjnych, przyjmujemy, że dane są wystarczające do podstawowej oceny.";
    }
    return { ...topic, answer: simulatedAnswer };
});

// --- Helper Components ---

const LoadingSpinner = () => (
    <div className="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-sky-500"></div>
);

const ErrorMessage = ({ message, type = "error" }) => {
    const bgColor = type === "info" ? "bg-sky-900/30" : "bg-red-900/30";
    const textColor = type === "info" ? "text-sky-300" : "text-red-400";
    return (
        <p className={`${textColor} mt-4 ${bgColor} p-3 rounded-md text-sm`}>{message}</p>
    );
};

// --- Chat Interface Component ---
function ChatInterface({ analysisSessionId, activeTopicId, initialTopicAnswer }) {
    const [messages, setMessages] = useState([]); 
    const [inputValue, setInputValue] = useState('');
    const [isAiTyping, setIsAiTyping] = useState(false);
    const [chatError, setChatError] = useState('');
    const messagesEndRef = useRef(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(scrollToBottom, [messages]);

    useEffect(() => {
        if (!analysisSessionId || !activeTopicId) {
            setMessages([{ sender: 'ai', text: 'Wybierz temat, aby rozpocząć czat lub zobaczyć historię.' }]);
            return;
        }

        const fetchChatHistory = async () => {
            setIsAiTyping(true);
            setChatError('');
            try {
                console.log(`[ChatInterface] STUB: Fetching chat history for session: ${analysisSessionId}, topic: ${activeTopicId}`);
                setTimeout(() => { 
                    setMessages([
                        { sender: 'ai', text: `Witaj! Czat dla tematu: ${activeTopicId}. Jak mogę pomóc? (Historia załadowana - STUB)` }
                    ]);
                    setIsAiTyping(false);
                }, 500);

            } catch (error) {
                console.error("[ChatInterface] Error fetching chat history:", error);
                setChatError(`Błąd ładowania historii czatu: ${error.message}`);
                setMessages([{sender: 'ai', text: 'Nie udało się załadować historii czatu.'}]);
            }
        };

        fetchChatHistory();
    }, [analysisSessionId, activeTopicId]);

    const handleInputChange = (e) => {
        setInputValue(e.target.value);
    };

    const handleSendMessage = async () => {
        if (inputValue.trim() === '' || !analysisSessionId || !activeTopicId) return;

        const userMessage = { sender: 'user', text: inputValue, timestamp: new Date().toISOString() };
        setMessages(prevMessages => [...prevMessages, userMessage]);
        const currentInput = inputValue; 
        setInputValue('');
        setIsAiTyping(true);
        setChatError('');

        try {
            console.log(`[ChatInterface] STUB: Sending message to /api/chat for session: ${analysisSessionId}, topic: ${activeTopicId}, message: ${currentInput}`);
            // STUB: Replace with actual API call to /api/chat
            
            setTimeout(() => {
                setMessages(prevMessages => [...prevMessages, { sender: 'ai', text: `Odpowiedź AI na: "${currentInput}" (STUB)`, timestamp: new Date().toISOString() }]);
                setIsAiTyping(false);
            }, 1000);


        } catch (error) {
            console.error("[ChatInterface] Error sending chat message:", error);
            setChatError(`Błąd wysyłania wiadomości: ${error.message}`);
            setMessages(prevMessages => [...prevMessages, {sender: 'ai', text: `Przepraszam, wystąpił błąd: ${error.message}`, timestamp: new Date().toISOString()}]);
            setIsAiTyping(false); 
        }
    };

    return (
        <div className="mt-8 pt-6 border-t border-slate-700">
            <h3 className="text-xl font-semibold mb-4 text-sky-400">Czat z AI (Kontekst Tematu)</h3>
            {chatError && <ErrorMessage message={chatError} />}
            <div className="bg-slate-700/50 p-4 rounded-lg h-64 overflow-y-auto mb-4 flex flex-col space-y-3 custom-scrollbar">
                {messages.map((msg, index) => (
                    <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[70%] p-3 rounded-xl text-sm md:text-base
                            ${msg.sender === 'user' ? 'bg-sky-600 text-white' : 'bg-slate-600 text-slate-200'}`}>
                            {msg.text.split('\n').map((line, i) => <p key={i} className={i > 0 ? 'mt-1' : ''}>{line}</p>)}
                        </div>
                    </div>
                ))}
                {isAiTyping && (
                    <div className="flex justify-start">
                         <div className="max-w-[70%] p-3 rounded-xl bg-slate-600 text-slate-200 text-sm md:text-base">
                            <span className="italic">AI pisze...</span>
                         </div>
                    </div>
                )}
                <div ref={messagesEndRef} />
            </div>
            <div className="flex space-x-2">
                <input
                    type="text"
                    value={inputValue}
                    onChange={handleInputChange}
                    onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                    placeholder={(!analysisSessionId || !activeTopicId) ? "Wybierz temat analizy, aby aktywować czat" : "Zadaj pytanie AI..."}
                    className="flex-grow p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-slate-100 placeholder-slate-400"
                    disabled={!analysisSessionId || !activeTopicId || isAiTyping}
                />
                <button
                    onClick={handleSendMessage}
                    className="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-5 rounded-lg transition duration-150 ease-in-out disabled:opacity-50"
                    disabled={!analysisSessionId || !activeTopicId || isAiTyping || inputValue.trim() === ''}
                >
                    Wyślij
                </button>
            </div>
        </div>
    );
}

// --- Core Page Components ---

function LandingPage({ onNavigate, onAnalyzeFile, onDemoTest, isLoading }) {
    const [file, setFile] = useState(null);
    const [localMessage, setLocalMessage] = useState({ text: '', type: 'error' });
    const [showWitnessInputs, setShowWitnessInputs] = useState(false); // New state for inline inputs
    const [digitalTwinId, setDigitalTwinId] = useState('');
    const [accessCodeId, setAccessCodeId] = useState('');


    const handleFileChange = (event) => {
        const selectedFile = event.target.files[0];
        if (selectedFile) {
            if (selectedFile.type === "text/csv" || selectedFile.name.endsWith(".csv")) {
                setFile(selectedFile);
                setLocalMessage({ text: '', type: 'error' }); 
            } else {
                setFile(null);
                setLocalMessage({ text: 'Proszę wybrać plik w formacie CSV.', type: 'error' });
            }
        }
    };

    const handleSubmitFile = () => {
        if (!file) {
            setLocalMessage({ text: 'Proszę wybrać plik CSV do analizy.', type: 'error' });
            return;
        }
        setLocalMessage({ text: '', type: 'error' }); 
        onAnalyzeFile(file); 
    };

    const handleToggleWitnessInputs = () => {
        setShowWitnessInputs(!showWitnessInputs);
        setLocalMessage({ text: '', type: 'error' }); // Clear messages when toggling
        if (showWitnessInputs) { // If we are closing it, clear the inputs
            setDigitalTwinId('');
            setAccessCodeId('');
        }
    };

    const handleWitnessConnect = (e) => {
        e.preventDefault(); // Prevent form submission if it's part of a form
        console.log('[LandingPage] Witness Connect Attempt. Digital Twin ID:', digitalTwinId, 'Access Code ID:', accessCodeId.substring(0,1) + '...');
        // Here you would typically make an API call to connect to the Digital Twin
        // For now, just show the "not found" message and hide inputs
        setLocalMessage({ text: 'Digital twin not found.', type: 'info' }); 
        // Optionally hide inputs after attempt, or leave them for another try
        // setShowWitnessInputs(false); 
        // setDigitalTwinId('');
        // setAccessCodeId('');
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center p-6 font-sans">
            <div className="bg-slate-800 p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-xl text-center">
                <h1 className="text-4xl md:text-5xl font-bold mb-3 text-sky-400">{APP_TITLE}</h1>
                <p className="text-slate-300 mb-8 text-lg">{APP_SUBTITLE_FULL}</p>

                {/* CSV Analysis Section */}
                <div className="mb-6 space-y-3">
                    <div>
                        <label htmlFor="file-upload" className="w-full cursor-pointer bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg inline-block transition duration-150 ease-in-out shadow-md hover:shadow-lg">
                            {file ? `Wybrano: ${file.name}` : 'Wybierz plik CSV'}
                        </label>
                        <input id="file-upload" type="file" accept=".csv,text/csv" onChange={handleFileChange} className="hidden" />
                    </div>
                    <button
                        onClick={handleSubmitFile}
                        className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-150 ease-in-out shadow-lg hover:shadow-xl disabled:opacity-50"
                        disabled={!file || isLoading}
                    >
                        Analizuj Plik
                    </button>
                </div>

                <div className="my-4 flex items-center">
                    <hr className="flex-grow border-t border-slate-700" />
                    <span className="px-3 text-slate-500 text-sm">LUB</span>
                    <hr className="flex-grow border-t border-slate-700" />
                </div>

                {/* Demo Test Button */}
                <button
                    onClick={onDemoTest}
                    className="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-150 ease-in-out shadow-lg hover:shadow-xl disabled:opacity-50 mb-4"
                    disabled={isLoading}
                >
                    Uruchom Test z Danymi Demo
                </button>

                {/* Witness Digital Twin Section Toggle Button */}
                <button
                    onClick={handleToggleWitnessInputs}
                    className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-150 ease-in-out shadow-lg hover:shadow-xl disabled:opacity-50"
                    disabled={isLoading}
                >
                    {showWitnessInputs ? 'Ukryj Opcje Digital Twin' : 'Połącz z Witness Digital Twin'}
                </button>

                {/* Inline Witness Digital Twin Inputs */}
                {showWitnessInputs && (
                    <form onSubmit={handleWitnessConnect} className="mt-6 space-y-4 bg-slate-700/30 p-6 rounded-lg">
                        <div>
                            <label htmlFor="digitalTwinIdInput" className="block text-sm font-medium text-slate-300 mb-1 text-left">Digital Twin ID:</label>
                            <input
                                type="text"
                                id="digitalTwinIdInput"
                                value={digitalTwinId}
                                onChange={(e) => setDigitalTwinId(e.target.value)}
                                className="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none placeholder-slate-400"
                                placeholder="Wprowadź ID Bliźniaka Cyfrowego"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="accessCodeIdInput" className="block text-sm font-medium text-slate-300 mb-1 text-left">Access Code ID:</label>
                            <input
                                type="password"
                                id="accessCodeIdInput"
                                value={accessCodeId}
                                onChange={(e) => setAccessCodeId(e.target.value)}
                                className="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none placeholder-slate-400"
                                placeholder="Wprowadź ID Kodu Dostępu"
                                required
                            />
                        </div>
                        <div className="flex justify-end space-x-3 pt-2">
                            <button
                                type="button"
                                onClick={handleToggleWitnessInputs} 
                                className="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-slate-200 font-semibold rounded-lg transition duration-150"
                            >
                                Anuluj
                            </button>
                            <button
                                type="submit"
                                className="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg transition duration-150"
                            >
                                Połącz
                            </button>
                        </div>
                    </form>
                )}
                
                {localMessage.text && <ErrorMessage message={localMessage.text} type={localMessage.type} />}
            </div>
            <footer className="fixed bottom-4 text-center w-full text-slate-500 text-sm">
                {APP_TITLE} - Wersja demonstracyjna
            </footer>
        </div>
    );
}

function ResultsPage({ onNavigate, analysisSessionId, analysisResults, isLoading, globalError, originalCsvDataForChat }) {
    const [activeTopic, setActiveTopic] = useState(null);
    const safeResults = Array.isArray(analysisResults) ? analysisResults : [];

    useEffect(() => {
        if (safeResults.length > 0) {
            const currentActiveStillValid = activeTopic && safeResults.find(r => r.id === activeTopic.id);
            if (!activeTopic || !currentActiveStillValid) {
                setActiveTopic(safeResults[0]);
            }
        } else {
            setActiveTopic(null); 
        }
    }, [safeResults, activeTopic]); 

    if (isLoading && safeResults.length === 0) { 
        return (
            <div className="min-h-screen bg-slate-900 text-white flex flex-col items-center justify-center p-6">
                <LoadingSpinner />
                <p className="mt-4 text-xl">Analizowanie danych...</p>
            </div>
        );
    }

    if (globalError) {
        return (
            <div className="min-h-screen bg-slate-900 text-white flex flex-col items-center justify-center p-6 text-center">
                <h2 className="text-3xl font-semibold mb-4 text-red-400">Błąd Analizy</h2>
                <ErrorMessage message={globalError} />
                <button onClick={() => onNavigate('landing')} className="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-150">
                    Wróć do strony głównej
                </button>
            </div>
        );
    }
    
    if (safeResults.length === 0 && !isLoading) {
        return (
            <div className="min-h-screen bg-slate-900 text-white flex flex-col items-center justify-center p-6 text-center">
                <h2 className="text-3xl font-semibold mb-4 text-sky-400">Brak wyników</h2>
                <p className="text-slate-300 mb-6">Nie udało się wygenerować analizy lub nie ma dostępnych wyników.</p>
                <button onClick={() => onNavigate('landing')} className="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-150">
                    Wróć do strony głównej
                </button>
            </div>
        );
    }
    
    const getInitialAnswerForActiveTopic = () => {
        if (activeTopic && safeResults) {
            const result = safeResults.find(r => r.id === activeTopic.id);
            return result ? result.answer : "Brak wstępnej analizy dla tego tematu.";
        }
        return "Wybierz temat, aby zobaczyć analizę.";
    };


    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white flex flex-col md:flex-row p-4 md:p-6 space-y-4 md:space-y-0 md:space-x-6 font-sans">
            <aside className="md:w-1/3 lg:w-1/4 bg-slate-800 p-6 rounded-xl shadow-xl flex flex-col" style={{ maxHeight: 'calc(100vh - 3rem)' }}>
                <h2 className="text-2xl font-semibold mb-6 text-sky-400 border-b border-slate-700 pb-3">Tematy Analizy</h2>
                <nav className="flex-grow overflow-y-auto pr-2 custom-scrollbar">
                    <ul>
                        {safeResults.map((result) => (
                            <li key={result.id} className="mb-2">
                                <button
                                    onClick={() => setActiveTopic(result)}
                                    className={`w-full text-left p-3 rounded-md transition-all duration-150 ease-in-out focus:outline-none ${activeTopic && activeTopic.id === result.id ? 'bg-sky-600 text-white shadow-md' : 'hover:bg-slate-700 text-slate-300'}`}
                                >
                                    {result.title || 'Brak tytułu'}
                                </button>
                            </li>
                        ))}
                    </ul>
                </nav>
                <button onClick={() => onNavigate('landing')} className="mt-8 w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-md flex-shrink-0">
                    Analizuj Nowy Plik
                </button>
            </aside>

            <main className="md:w-2/3 lg:w-3/4 bg-slate-800 p-6 md:p-8 rounded-xl shadow-xl overflow-y-auto custom-scrollbar" style={{ maxHeight: 'calc(100vh - 3rem)' }}>
                {activeTopic ? (
                    <>
                        <h1 className="text-3xl font-bold mb-6 text-sky-400 border-b border-slate-700 pb-3">
                            {activeTopic.title || 'Brak tytułu'}
                        </h1>
                        <div
                            className="prose prose-sm sm:prose-base prose-invert max-w-none text-slate-200 leading-relaxed whitespace-pre-wrap" 
                            dangerouslySetInnerHTML={{ __html: (activeTopic.answer || "").replace(/\n/g, '<br />') }}
                        />
                        <ChatInterface 
                            analysisSessionId={analysisSessionId} 
                            activeTopicId={activeTopic.id}
                            initialTopicAnswer={getInitialAnswerForActiveTopic()} 
                        />
                    </>
                ) : (
                    <div className="flex items-center justify-center h-full">
                        <p className="text-slate-400 text-xl">Wybierz temat z listy po lewej stronie, aby wyświetlić analizę.</p>
                    </div>
                )}
            </main>
        </div>
    );
}

// Main App Component
function App() {
    const [currentPage, setCurrentPage] = useState('landing');
    const [analysisSessionId, setAnalysisSessionId] = useState(null); 
    const [analysisResults, setAnalysisResults] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [globalError, setGlobalError] = useState('');
    const [originalCsvForChat, setOriginalCsvForChat] = useState(SAMPLE_CSV_DATA_FOR_DEMO);

    const navigate = (page) => {
        setCurrentPage(page);
        if (page === 'landing') {
            setAnalysisResults([]);
            setAnalysisSessionId(null); 
            setGlobalError('');
        }
    };

    const generateUniqueId = () => `session_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`;

    const handleAnalyzeFileWithApi = async (fileObject) => {
        setIsLoading(true);
        setGlobalError('');
        setAnalysisResults([]);
        const newSessionId = generateUniqueId(); 
        setAnalysisSessionId(newSessionId);

        const reader = new FileReader();
        reader.onload = async (event) => {
            const csvDataString = event.target.result;
            setOriginalCsvForChat(csvDataString); 
            try {
                const response = await fetch('/api/analyze', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        csvData: csvDataString, 
                        topics: PREDEFINED_TOPICS,
                        analysisSessionId: newSessionId 
                    }),
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({})); 
                    throw new Error(errData.error || `Błąd serwera: ${response.status} - ${response.statusText}`);
                }

                const results = await response.json();
                if (!results.analysis || !Array.isArray(results.analysis)) {
                    throw new Error("Odpowiedź serwera nie zawierała oczekiwanych danych analizy.");
                }
                
                setAnalysisResults(results.analysis);
                navigate('results');
            } catch (err) {
                console.error("Błąd podczas analizy pliku (backend):", err);
                setGlobalError(`Nie udało się przeanalizować pliku: ${err.message}. Sprawdź konsolę przeglądarki i logi serwera (jeśli dostępne).`);
                navigate('results'); 
            } finally {
                setIsLoading(false);
            }
        };
        reader.onerror = () => {
            console.error("Błąd odczytu pliku.");
            setGlobalError("Nie udało się odczytać pliku.");
            setIsLoading(false);
            navigate('results');
        };
        reader.readAsText(fileObject, 'UTF-8');
    };

    const handleDemoTestFlow = () => {
        setIsLoading(true);
        setGlobalError('');
        setAnalysisResults([]);
        const demoSessionId = `demo_${Date.now()}`; 
        setAnalysisSessionId(demoSessionId);
        setOriginalCsvForChat(SAMPLE_CSV_DATA_FOR_DEMO);

        setTimeout(() => {
            setAnalysisResults(SIMULATED_ANALYSIS_RESULTS);
            navigate('results');
            setIsLoading(false);
        }, 800); 
    };

    switch (currentPage) {
        case 'landing':
            return <LandingPage 
                        onNavigate={navigate}
                        onAnalyzeFile={handleAnalyzeFileWithApi} 
                        onDemoTest={handleDemoTestFlow}
                        isLoading={isLoading} 
                    />;
        case 'results':
            return <ResultsPage 
                        onNavigate={navigate}
                        analysisSessionId={analysisSessionId} 
                        analysisResults={analysisResults} 
                        isLoading={isLoading}
                        globalError={globalError} 
                        originalCsvDataForChat={originalCsvForChat}
                    />;
        default: 
            return <LandingPage 
                        onNavigate={navigate}
                        onAnalyzeFile={handleAnalyzeFileWithApi} 
                        onDemoTest={handleDemoTestFlow}
                        isLoading={isLoading} 
                    />;
    }
}

export default App;
